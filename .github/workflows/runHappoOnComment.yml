name: Run Happo on PR comment
on:
  issue_comment:
    types:
      - created

jobs:
  run-happo:
    if: ${{ github.event.issue.pull_request && github.event.comment.body == 'run happo now' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get pull request branches
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pull_number = context.payload.issue.number;
            const { owner, repo } = context.repo;

            async function getPullRequestInfo() {
              const response = await github.rest.pulls.get({
                owner,
                repo,
                pull_number,
              });

              const previousSHA = response.data.base.sha;
              const currentSHA = response.data.head.sha;
              const changeURL = response.data.html_url;

              return { previousSHA, currentSHA, changeURL };
            }

            const { previousSHA, currentSHA, changeURL } = await getPullRequestInfo();
            console.log('PREVIOUS SHA:', previousSHA);
            console.log('CURRENT SHA:', currentSHA);
            console.log('CHANGE URL:', changeURL);

            // Set environment variables
            process.env.PREVIOUS_SHA = previousSHA;
            process.env.CURRENT_SHA = currentSHA;
            process.env.CHANGE_URL = changeURL;

      - name: Display environment variables
        run: |
          echo "PREVIOUS SHA: $PREVIOUS_SHA"
          echo "CURRENT SHA: $CURRENT_SHA"
          echo "CHANGE URL: $CHANGE_URL"
