name: Run Happo on PR comment
on:
  issue_comment:
    types:
      - created

jobs:
  run-happo:
    if: ${{ github.event.issue.pull_request && github.event.comment.body == 'run happo now' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get pull request branches
        uses: actions/github-script@v7
        id: get-pull-request-info
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pull_number = context.payload.issue.number;
            const { owner, repo } = context.repo;

            async function getPullRequestInfo() {
              const response = await github.rest.pulls.get({
                owner,
                repo,
                pull_number,
              });

              const previousSHA = response.data.base.sha;
              const currentSHA = response.data.head.sha;
              const changeURL = response.data.html_url;

              console.log('Previous SHA:', previousSHA);
              console.log('Current SHA:', currentSHA);
              console.log('Change URL:', changeURL);

              return { previousSHA, currentSHA, changeURL };
            }

            return await getPullRequestInfo();

      - name: Display pull request info
        run: |
          echo "Pull request info result: ${{ steps.get-pull-request-info.outputs.result }}"

      - name: Set environment variables
        run: |
          echo "PREVIOUS_SHA=${{ steps.get-pull-request-info.outputs.result.previousSHA }}" >> $GITHUB_ENV
          echo "CURRENT_SHA=${{ steps.get-pull-request-info.outputs.result.currentSHA }}" >> $GITHUB_ENV
          echo "CHANGE_URL=${{ steps.get-pull-request-info.outputs.result.changeURL }}" >> $GITHUB_ENV

      - name: Display environment variables
        run: |
          echo "PREVIOUS SHA: $PREVIOUS_SHA"
          echo "CURRENT SHA: $CURRENT_SHA"
          echo "CHANGE URL: $CHANGE_URL"
